generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Workspace {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  awsAccountId String?
  awsRegion    String   @default("us-east-1")

  users                 User[]
  instances             Instance[]
  botInstances          BotInstance[]
  fleets                Fleet[]
  templates             Template[]
  profiles              Profile[]
  overlays              Overlay[]
  policyPacks           PolicyPack[]
  integrationConnectors IntegrationConnector[]
  auditEvents           AuditEvent[]
  skillPacks            SkillPack[]
  communicationChannels CommunicationChannel[]

  @@index([slug])
}

model User {
  id          String    @id @default(cuid())
  email       String
  name        String
  role        UserRole  @default(VIEWER)
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  manifests   ManifestVersion[]
  auditEvents AuditEvent[]

  @@unique([email, workspaceId])
}

enum UserRole {
  OWNER
  ADMIN
  OPERATOR
  VIEWER
}

// Auth model for simple JWT-based authentication
model AuthUser {
  id          String    @id @default(cuid())
  username    String    @unique
  passwordHash String
  role        UserRole  @default(OPERATOR)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([username])
  @@index([isActive])
}

// Fleet: Grouping concept for environments
model Fleet {
  id          String      @id @default(cuid())
  name        String
  workspaceId String
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  environment Environment
  description String?
  status      FleetStatus @default(ACTIVE)
  tags        Json        @default("{}")

  // Infrastructure references
  ecsClusterArn    String?
  vpcId            String?
  privateSubnetIds Json    @default("[]")
  securityGroupId  String?

  // Configuration
  defaultProfileId      String?
  enforcedPolicyPackIds Json    @default("[]")

  defaultDeploymentType DeploymentType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instances BotInstance[]
  profiles  Profile[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([status])
}

enum FleetStatus {
  ACTIVE
  PAUSED
  DRAINING
  ERROR
}

// Enhanced BotInstance with fleet association
model BotInstance {
  id          String    @id @default(cuid())
  name        String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  fleetId     String
  fleet       Fleet     @relation(fields: [fleetId], references: [id], onDelete: Cascade)

  // Configuration layers
  templateId String?
  profileId  String?
  overlayIds Json    @default("[]")

  // Current state
  status                 BotStatus @default(CREATING)
  health                 BotHealth @default(UNKNOWN)
  desiredManifest        Json
  appliedManifestVersion String?

  // Operational metadata
  tags     Json @default("{}")
  metadata Json @default("{}")

  // Runtime info
  lastReconcileAt   DateTime?
  lastHealthCheckAt DateTime?
  lastError         String?
  errorCount        Int       @default(0)

  // AWS resources
  ecsClusterArn      String?
  ecsServiceArn      String?
  taskDefinitionArn  String?
  cloudwatchLogGroup String?

  // Health metrics
  uptimeSeconds Int @default(0)
  restartCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Moltbot-native fields
  deploymentType     DeploymentType?
  deploymentTargetId String?
  deploymentTarget   DeploymentTarget? @relation(fields: [deploymentTargetId], references: [id])
  gatewayPort        Int?
  profileName        String?
  moltbotVersion     String?
  configHash         String?

  // Relations
  connectorBindings   BotConnectorBinding[]
  changeSets          ChangeSet[]
  traces              Trace[]
  skillPacks          BotInstanceSkillPack[]
  channelBindings     BotChannelBinding[]
  gatewayConnection   GatewayConnection?
  moltbotProfile      MoltbotProfile?
  channelAuthSessions ChannelAuthSession[]
  healthSnapshots     HealthSnapshot[]
  securityAudits      SecurityAuditResult[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([fleetId])
  @@index([status])
  @@index([health])
}

enum BotStatus {
  CREATING
  PENDING
  RUNNING
  DEGRADED
  STOPPED
  PAUSED
  DELETING
  ERROR
  RECONCILING
}

enum BotHealth {
  HEALTHY
  UNHEALTHY
  UNKNOWN
  DEGRADED
}

// Legacy Instance model (kept for compatibility, migrate to BotInstance)
model Instance {
  id                String         @id @default(cuid())
  workspaceId       String
  workspace         Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  name              String
  environment       Environment    @default(dev)
  tags              Json           @default("{}")
  status            InstanceStatus @default(CREATING)
  desiredManifestId String?
  lastReconcileAt   DateTime?
  lastError         String?

  // AWS resources
  ecsClusterArn      String?
  ecsServiceArn      String?
  taskDefinitionArn  String?
  cloudwatchLogGroup String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  manifests        ManifestVersion[]
  deploymentEvents DeploymentEvent[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([status])
}

enum Environment {
  dev
  staging
  prod
}

enum InstanceStatus {
  CREATING
  RUNNING
  DEGRADED
  STOPPED
  DELETING
  ERROR
}

// Profile: Shared defaults for instances
model Profile {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Scope
  fleetIds Json @default("[]") // Empty = available to all fleets

  // Default configurations
  defaults      Json // Profile defaults object
  mergeStrategy Json @default("{}")

  // Override settings
  allowInstanceOverrides Boolean @default(true)
  lockedFields           Json    @default("[]")

  // Priority for applying multiple profiles
  priority Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  fleets Fleet[]

  @@index([workspaceId])
  @@index([isActive])
}

// Overlay: Per-bot configuration overrides
model Overlay {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Target specification
  targetType     String // instance, fleet, environment, tag
  targetSelector Json // Selector criteria

  // Override values
  overrides Json // Override configuration

  // Behavior
  priority Int     @default(0)
  enabled  Boolean @default(true)
  rollout  Json? // Rollout configuration
  schedule Json? // Schedule for temporary overlays

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([workspaceId])
  @@index([enabled])
  @@index([targetType])
}

// PolicyPack: Enforced rules
model PolicyPack {
  id          String     @id @default(cuid())
  name        String
  description String
  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Scope
  isBuiltin          Boolean @default(false)
  autoApply          Boolean @default(false)
  targetWorkspaces   Json?
  targetEnvironments Json?
  targetTags         Json?

  // Rules
  rules Json // Array of PolicyRule objects

  // Settings
  isEnforced Boolean @default(false)
  priority   Int     @default(0)
  version    String  @default("1.0.0")
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([workspaceId])
  @@index([isBuiltin])
  @@index([isActive])
  @@index([autoApply])
}

// IntegrationConnector: Shared credentials
model IntegrationConnector {
  id          String    @id @default(cuid())
  name        String
  description String
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Type and configuration
  type   String // openai, slack, discord, etc.
  config Json // ConnectionConfig object

  // Status
  status         ConnectorStatus @default(PENDING)
  statusMessage  String?
  lastTestedAt   DateTime?
  lastTestResult String?
  lastError      String?

  // Sharing
  isShared           Boolean @default(true)
  allowedInstanceIds Json? // If not shared, specific instances

  // Rotation
  rotationSchedule Json?

  // Usage tracking
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  tags Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  botBindings BotConnectorBinding[]

  @@index([workspaceId])
  @@index([type])
  @@index([status])
}

enum ConnectorStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
}

// Bot to Connector binding
model BotConnectorBinding {
  id            String               @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance          @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  connectorId   String
  connector     IntegrationConnector @relation(fields: [connectorId], references: [id], onDelete: Cascade)

  purpose       String // llm, channel, database, etc.
  channelConfig Json? // Channel-specific configuration
  overrides     Json? // Bot-specific overrides

  healthStatus    String    @default("UNKNOWN")
  lastHealthCheck DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([botInstanceId, connectorId, purpose])
  @@index([botInstanceId])
  @@index([connectorId])
}

// ChangeSet: Track configuration changes
model ChangeSet {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)

  changeType  String // UPDATE, ROLLOUT, ROLLBACK
  description String

  // Change details
  fromManifest Json?
  toManifest   Json

  // Rollout configuration
  rolloutStrategy   String @default("ALL") // ALL, PERCENTAGE, CANARY
  rolloutPercentage Int?
  canaryInstances   Json?

  // Status
  status String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, ROLLED_BACK

  // Progress tracking
  totalInstances   Int @default(0)
  updatedInstances Int @default(0)
  failedInstances  Int @default(0)

  startedAt   DateTime?
  completedAt DateTime?

  // Rollback info
  canRollback  Boolean   @default(false)
  rolledBackAt DateTime?
  rolledBackBy String?

  createdAt DateTime @default(now())
  createdBy String

  // Relations
  auditEvents AuditEvent[]

  @@index([botInstanceId])
  @@index([status])
  @@index([createdAt])
}

// Trace: Execution traces
model Trace {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)

  traceId       String  @unique // External trace ID
  parentTraceId String?

  // Trace metadata
  name   String
  type   String // REQUEST, TASK, SKILL, etc.
  status String // SUCCESS, ERROR, PENDING

  // Timing
  startedAt  DateTime
  endedAt    DateTime?
  durationMs Int?

  // Details
  input  Json?
  output Json?
  error  Json?

  // Context
  metadata Json @default("{}")
  tags     Json @default("{}")

  createdAt DateTime @default(now())

  @@index([botInstanceId])
  @@index([traceId])
  @@index([startedAt])
  @@index([status])
}

// Credential Rotation tracking
model CredentialRotation {
  id          String @id @default(cuid())
  connectorId String

  triggeredBy     String // schedule, manual, security
  triggeredAt     DateTime
  triggeredByUser String?

  status String // PENDING, IN_PROGRESS, COMPLETED, FAILED, ROLLED_BACK

  startedAt   DateTime?
  completedAt DateTime?

  oldSecretArn String?
  newSecretArn String?

  instancesUpdated Int @default(0)
  instancesTotal   Int @default(0)

  canRollback  Boolean   @default(false)
  rolledBackAt DateTime?

  error String?

  createdAt DateTime @default(now())

  @@index([connectorId])
  @@index([status])
}

model ManifestVersion {
  id         String   @id @default(cuid())
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  version    Int
  content    Json
  createdBy  String
  user       User     @relation(fields: [createdBy], references: [id])
  createdAt  DateTime @default(now())

  @@unique([instanceId, version])
  @@index([instanceId])
}

model AuditEvent {
  id           String    @id @default(cuid())
  actor        String
  user         User      @relation(fields: [actor], references: [id])
  action       String
  resourceType String
  resourceId   String
  diffSummary  String?
  metadata     Json      @default("{}")
  timestamp    DateTime  @default(now())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Optional relations
  changeSetId String?
  changeSet   ChangeSet? @relation(fields: [changeSetId], references: [id])

  @@index([workspaceId])
  @@index([resourceType, resourceId])
  @@index([timestamp])
  @@index([changeSetId])
}

model Template {
  id               String     @id @default(cuid())
  name             String
  description      String
  category         String
  manifestTemplate Json
  isBuiltin        Boolean    @default(false)
  workspaceId      String?
  workspace        Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([workspaceId])
  @@index([category])
}

model DeploymentEvent {
  id         String              @id @default(cuid())
  instanceId String
  instance   Instance            @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  eventType  DeploymentEventType
  message    String
  metadata   Json                @default("{}")
  createdAt  DateTime            @default(now())

  @@index([instanceId])
  @@index([createdAt])
}

enum DeploymentEventType {
  RECONCILE_START
  RECONCILE_SUCCESS
  RECONCILE_ERROR
  ECS_DEPLOYMENT
  ECS_ROLLBACK
  DRIFT_DETECTED
}

// SkillPack: Reusable bundle of skills and MCPs for multiple bots
model SkillPack {
  id          String   @id @default(cuid())
  name        String
  description String?
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // Skills configuration (e.g., [{"name": "github", "version": "1.0.0"}])
  skills Json @default("[]")
  
  // MCP servers configuration
  // e.g., [{"name": "github", "command": "npx -y @modelcontextprotocol/server-github"}]
  mcps Json @default("[]")
  
  // Environment variables shared across all bots using this pack
  envVars Json @default("{}")
  
  // Whether this is a built-in pack (provided by Molthub)
  isBuiltin Boolean @default(false)
  
  // Version for tracking changes
  version Int @default(1)
  
  // Relations
  botInstances BotInstanceSkillPack[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  
  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([isBuiltin])
}

// Junction table for BotInstance <-> SkillPack many-to-many relation
model BotInstanceSkillPack {
  id            String      @id @default(cuid())
  botInstanceId String
  botInstance   BotInstance @relation(fields: [botInstanceId], references: [id], onDelete: Cascade)
  skillPackId   String
  skillPack     SkillPack   @relation(fields: [skillPackId], references: [id], onDelete: Cascade)

  // Instance-specific overrides (merged with pack defaults)
  envOverrides Json @default("{}")

  // When this pack was attached to the bot
  attachedAt DateTime @default(now())

  @@unique([botInstanceId, skillPackId])
  @@index([botInstanceId])
  @@index([skillPackId])
}

// ============================================
// COMMUNICATION CHANNELS
// Configure and monitor messaging channels per bot
// ============================================

enum ChannelType {
  SLACK
  TELEGRAM
  DISCORD
  EMAIL
  WEBHOOK
  SMS
  PUSHOVER
  CUSTOM
}

enum ChannelStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
  DEGRADED
}

model CommunicationChannel {
  id          String   @id @default(cuid())
  name        String   // e.g., "Support Slack", "Alerts Telegram"
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  type ChannelType

  // Channel configuration (type-specific)
  // Slack: { token: string, channelId?: string }
  // Telegram: { botToken: string, chatId?: string }
  // Discord: { botToken: string, guildId?: string, channelId?: string }
  // Email: { smtpHost, smtpPort, username, password, fromAddress }
  // Webhook: { url, headers?, secret? }
  config Json

  // Default settings for this channel
  defaults Json @default("{}")
  // e.g., { mentionOnError: true, quietHours: { start: "22:00", end: "08:00" } }

  // Status tracking
  status        ChannelStatus @default(PENDING)
  statusMessage String?
  lastTestedAt  DateTime?
  lastError     String?
  errorCount    Int @default(0)

  // Health metrics
  messagesSent     Int @default(0)
  messagesFailed   Int @default(0)
  lastMessageAt    DateTime?
  lastActivityAt   DateTime?

  // Sharing
  isShared Boolean @default(true)  // Can be used by multiple bots

  tags Json @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  // Relations
  botBindings BotChannelBinding[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@index([type])
  @@index([status])
}

// Binding between Bot and CommunicationChannel
model BotChannelBinding {
  id        String @id @default(cuid())
  botId     String
  bot       BotInstance @relation(fields: [botId], references: [id], onDelete: Cascade)
  channelId String
  channel   CommunicationChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Purpose: notifications, alerts, user-messages, logs, etc.
  purpose String @default("notifications")

  // Bot-specific overrides (merged with channel defaults)
  settings Json @default("{}")
  // e.g., {
  //   filters: [{ type: "error", minSeverity: "high" }],
  //   formatting: "markdown",
  //   mentionUsers: ["@admin"],
  //   includeMetadata: true
  // }

  // Target destination (overrides channel default)
  // Slack: specific channel ID
  // Telegram: specific chat ID
  // Email: specific recipients
  targetDestination Json?

  // Status
  isActive Boolean @default(true)
  healthStatus String @default("UNKNOWN") // HEALTHY, UNHEALTHY, UNKNOWN
  lastHealthCheck DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([botId, channelId, purpose])
  @@index([botId])
  @@index([channelId])
  @@index([purpose])
}

// ============================================
// MOLTBOT-NATIVE ENUMS
// ============================================

enum DeploymentType {
  LOCAL
  REMOTE_VM
  DOCKER
  ECS_FARGATE
  CLOUD_RUN
  ACI
  KUBERNETES
}

enum GatewayConnectionStatus {
  CONNECTED
  DISCONNECTED
  CONNECTING
  ERROR
}

enum ChannelAuthState {
  PENDING
  PAIRING
  PAIRED
  EXPIRED
  ERROR
}

enum MoltbotChannelType {
  WHATSAPP
  TELEGRAM
  DISCORD
  SLACK
  SIGNAL
  IMESSAGE
  MATTERMOST
  GOOGLE_CHAT
  MS_TEAMS
  LINE
  MATRIX
}

// ============================================
// MOLTBOT-NATIVE MODELS
// ============================================

// GatewayConnection: Tracks the WebSocket connection to a Moltbot gateway
model GatewayConnection {
  id         String      @id @default(cuid())
  instanceId String      @unique
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  host     String @default("localhost")
  port     Int    @default(18789)
  authMode String @default("token") // "token" | "password"
  authToken String? // Encrypted gateway auth token

  status        GatewayConnectionStatus @default(DISCONNECTED)
  lastHeartbeat DateTime?
  configHash    String?
  latencyMs     Int?

  protocolVersion Int?
  clientMetadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

// MoltbotProfile: Local profile configuration for a bot instance
model MoltbotProfile {
  id         String      @id @default(cuid())
  instanceId String      @unique
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  profileName String
  configPath  String // e.g., ~/.clawdbot/profiles/<name>/moltbot.json
  stateDir    String // e.g., ~/.clawdbot/profiles/<name>/state/
  workspace   String // e.g., ~/clawd/<name>/
  basePort    Int    @default(18789)

  // Service management
  serviceName String? // e.g., bot.molt.<profile> or moltbot-gateway-<profile>.service
  serviceType String? // "launchd" | "systemd"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileName])
  @@index([instanceId])
}

// ChannelAuthSession: Tracks channel authentication/pairing flows
model ChannelAuthSession {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  channelType MoltbotChannelType
  state       ChannelAuthState @default(PENDING)

  // Auth flow data
  qrCodeData  String? // Base64 QR code for WhatsApp
  authToken   String? // Bot token for Telegram/Discord
  pairingCode String? // Pairing code for WhatsApp

  // Timing
  expiresAt DateTime?
  pairedAt  DateTime?

  // Error tracking
  lastError    String?
  attemptCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([instanceId])
  @@index([state])
  @@index([channelType])
}

// DeploymentTarget: Reusable deployment target configuration
model DeploymentTarget {
  id   String         @id @default(cuid())
  name String
  type DeploymentType

  // Type-specific configuration (JSON)
  // For remote-vm: { host, sshPort, username, privateKeyRef }
  // For docker: { imageName, networkName }
  // For kubernetes: { namespace, kubeContext }
  // For cloud: provider-specific settings
  config Json @default("{}")

  status        String   @default("active") // "active" | "inactive" | "error"
  statusMessage String?
  lastCheckedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  instances BotInstance[]

  @@index([type])
  @@index([status])
}

// SecurityAuditResult: Security audit findings for a bot instance
model SecurityAuditResult {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Findings
  findings      Json // Array of { ruleId, severity, message, field?, suggestedFix? }
  totalErrors   Int  @default(0)
  totalWarnings Int  @default(0)
  totalInfo     Int  @default(0)

  // Context
  configHash String?
  auditedAt  DateTime @default(now())
  auditedBy  String   @default("system")

  @@index([instanceId])
  @@index([auditedAt])
}

// HealthSnapshot: Point-in-time health data from a bot's gateway
model HealthSnapshot {
  id         String      @id @default(cuid())
  instanceId String
  instance   BotInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // Health data from Gateway
  data      Json    // Full health snapshot from Gateway WS
  isHealthy Boolean @default(true)

  // Channel health
  channelsLinked   Int @default(0)
  channelsDegraded Int @default(0)

  // Performance
  gatewayLatencyMs Int?

  capturedAt DateTime @default(now())

  @@index([instanceId])
  @@index([capturedAt])
  @@index([isHealthy])
}
